-- bai1
GO
CREATE PROC SP_CRUD_NhanVien(@id INT , @ma VARCHAR(20) , @ten NVARCHAR(30) , @tendem NVARCHAR(30) ,
								@ho NVARCHAR(30) , @gioitinh NVARCHAR(10) , @ngaysinh DATE , @diachi NVARCHAR(100),
								@sdt VARCHAR(30) , @maCH VARCHAR(20) , @maCV VARCHAR(20) , @manguoiguiBC VARCHAR(20),
								@trangthai INT , @SQL_Type VARCHAR(20))
AS

BEGIN

DECLARE @idCH INT , @idCV INT , @idNguoiguiBC INT
	SET @idCH = (SELECT TOP 1 Id FROM CuaHang WHERE Ma = @maCH)
	SET @idCV = (SELECT TOP 1 Id FROM ChucVu WHERE Ma = @maCV)
	SET @idNguoiguiBC = (SELECT TOP 1 Id FROM NhanVien WHERE Ma = @manguoiguiBC)
	IF @SQL_Type = 'SELECT'
	BEGIN
	SELECT * FROM NhanVien
	END
	IF @SQL_Type = 'INSERT'
	BEGIN
	IF (@ma IS NULL AND @ten IS NULL AND @tendem IS NULL AND @ho IS NULL)
	BEGIN
	PRINT 'Không cho phép 4 tham số khác null'
	END
	ELSE
	BEGIN
		BEGIN TRY
		INSERT INTO NhanVien VALUES ( UPPER(@ma) , UPPER(@ten) , UPPER(@tendem) , UPPER(@ho) 
        , UPPER(@gioitinh) , @ngaysinh ,UPPER(@diachi) ,UPPER(@sdt),
		@idCH , @idCV , @idNguoiguiBC ,@trangthai)
		END TRY
		BEGIN CATCH
		PRINT N'Thông Báo' + Cast(ERROR_NUMBER() AS NVARCHAR(30))
		PRINT N'Thông Báo' + ERROR_MESSAGE()
		PRINT N'Thông Báo' + Cast(ERROR_SEVERITY() AS NVARCHAR(30))
		PRINT N'Thông Báo' + Cast(ERROR_STATE() AS NVARCHAR(30))
		PRINT N'Thông Báo' + ERROR_PROCEDURE()
		END CATCH
	END
	END

	IF @SQL_Type = 'UPDATE'
	BEGIN
	BEGIN TRY
	UPDATE NhanVien
	SET  Ma =UPPER(@ma) , Ten = UPPER(@ten) , TenDem = UPPER(@tendem) , Ho =UPPER(@ho) , 
	GioiTinh =UPPER(@gioitinh) , NgaySinh =@ngaysinh,DiaChi = UPPER(@diachi) , Sdt =UPPER(@sdt) , 
	IdCH = @idCH , IdCV =@idCV , IdGuiBC =@idNguoiguiBC , TrangThai =@trangthai
	WHERE Ma = @ma
	END TRY
	BEGIN CATCH
		PRINT N'Thông Báo' + Cast(ERROR_NUMBER() AS NVARCHAR(30))
		PRINT N'Thông Báo' + ERROR_MESSAGE()
		PRINT N'Thông Báo' + Cast(ERROR_SEVERITY() AS NVARCHAR(30))
		PRINT N'Thông Báo' + Cast(ERROR_STATE() AS NVARCHAR(30))
		PRINT N'Thông Báo' + ERROR_PROCEDURE()
		END CATCH

	END

	IF @SQL_Type = 'DELETE'
	BEGIN
	DELETE FROM NhanVien WHERE Ma = @ma
	END
END

EXEC SP_CRUD_NhanVien @id = 0 , @ma = 'NV35' , @ten = N'Quân' , @tendem = N'Đăng' ,
								@ho = N'Hồ' , @gioitinh  = N'Nam' , @ngaysinh = '01-28-2003' , @diachi = N'Hà Nội',
								@sdt = '0358012003' , @maCH = 'CH1' , @maCV = 'NV' , @manguoiguiBC = 'NV1',
								@trangthai = 0 , @SQL_Type = 'SELECT'

-- bai 2

--View 2

GO

CREATE View View_QLNhanVien
AS

SELECT NhanVien.Ma , Ho + ' ' + TenDem + ' ' + NhanVien.Ten AS 'Họ tên đầy đủ' , NgaySinh ,dbo.tinhTuoi(NgaySinh) AS 'Tuổi' , 
NhanVien.Sdt ,NhanVien.DiaChi ,GioiTinh , ChucVu.Ten AS 'Tên Chức Vụ' , Sum(SoLuong) AS 'Số lượng sản phẩm đã bán' , Sum(SoLuong * DonGia) 
AS 'Só tiền đã bán'
From NhanVien
JOIN HoaDon ON HoaDon.IdNV = NhanVien.Id
JOIN HoaDonChiTiet ON HoaDonChiTiet.IdHoaDon = HoaDon.Id
JOIN ChucVu ON ChucVu.Id = NhanVien.IdCV
GROUP BY NhanVien.Ma , Ho + ' ' + TenDem + ' ' + NhanVien.Ten , NgaySinh ,dbo.tinhTuoi(NgaySinh) , NhanVien.Sdt ,
NhanVien.DiaChi ,GioiTinh , ChucVu.Ten 
GO

SELECT * FROM View_QLNhanVien


--Hàm 1 Tính Tuổi
GO
CREATE FUNCTION tinhTuoi(@ngaysinh DATE) 
RETURNS INT
AS
BEGIN
	RETURN (DateDiff(DAYOFYEAR, @ngaysinh ,getdate())) / 365
END

GO
PRINT dbo.tinhTuoi('03-04-2007')
-- Hàm 2 Tính số lượng nhân viên theo giới tính tham số truyền vào

GO

CREATE FUNCTION soLuongNVTheoGioiTinh(@gioitinh nvarchar(10))
RETURNS INT
AS
BEGIN
	RETURN (SELECT count(Id) FROM NhanVien WHERE GioiTinh = @gioitinh)
END
GO

PRINT N'Tổng số lượng nhân viên Nam : ' + Convert(VARCHAR , dbo.soLuongNVTheoGioiTinh(N'Nam'))


--bai4
--cau 3
GO
CREATE view BAO_CAO_1 AS
SELECT HoaDon.Id,NhanVien.Ma,NhanVien.Ten,HoaDon.NgayTao,HoaDon.NgayShip,DAY(NgayNhan)-DAY(NgayShip) 'ngày chậm',
KhachHang.Ten N'Tên khách hàng',KhachHang.Sdt,CuaHang.Ten N'Tên cửa hàng' 
FROM HoaDon
JOIN KhachHang ON HoaDon.IdKH = KhachHang.Id 
JOIN NhanVien ON NhanVien.Id = HoaDon.IdNV 
JOIN CuaHang ON CuaHang.Id = NhanVien.IdCH
GO
SELECT * FROM BAO_CAO_1 


-- cau 1
GO
CREATE VIEW KHACH_HANG AS
SELECT KhachHang.Ma,KhachHang.Ho +' '+ KhachHang.TenDem +' '+ KhachHang.Ten [Họ Và Tên],KhachHang.NgaySinh,KhachHang.Sdt,
KhachHang.DiaChi,KhachHang.ThanhPho,SUM(HoaDonChiTiet.SoLuong) [Số lượng đơn hàng],SUM(HoaDonChiTiet.SoLuong*HoaDonChiTiet.DonGia) 
[Tổng tiền đã chi tiêu]  
FROM KhachHang JOIN HoaDon ON KhachHang.Id = HoaDon.IdKH 
JOIN HoaDonChiTiet ON HoaDonChiTiet.IdHoaDon = HoaDon.Id
GROUP BY KhachHang.Ma,KhachHang.Ho +' '+ KhachHang.TenDem +' '+ KhachHang.Ten,KhachHang.NgaySinh,KhachHang.Sdt,
KhachHang.DiaChi,KhachHang.ThanhPho
GO
SELECT * FROM KHACH_HANG
